## ALB

## 接続のアイドルタイムアウト
クライアント<-> ALB間はフロントエンド接続、ALB<->ターゲット間はバックエンド接続と呼ぶ

> ロードバランサーは、各フロントエンド接続で、指定された期間に接続でデータが送信されない場合にトリガーされるアイドルタイムアウトを管理します。アイドルタイムアウトが経過するまでデータが送受信されなかった場合、ロードバランサーはフロントエンド接続を閉じます。

> バックエンド接続では EC2 インスタンスにキープアライブオプションを有効にすることが推奨されます。ウェブサーバーの設定または EC2 インスタンスのカーネル設定で、キープアライブを有効にすることができます。キープアライブを有効にすると、オペレーション完了時にインスタンスがバックエンド接続を切断できるようになります。

カーネルのkeepaliveの設定は以下

- tcp_keepalive_time  :
- tcp_keepalive_intvl :
- tcp_keepalive_probes:

ジャンボフレームを使えるようにするにはMTUの設定が必要 [EC2 インスタンスの最大ネットワーク送信単位 \(MTU\) \- Amazon Elastic Compute Cloud](http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/network_mtu.html#path_mtu_discovery)

## ALBの監視
### Cloudwatch メトリクス
- HTTPCode_ELB_4XX_Count はClient <-> ALB間のフロントエンド接続。ターゲットへ通信は流れていない
- HTTPCode_Target_2XX_Count はALB<->ターゲットのバックエンド接続。ターゲットによって生成されたHTTP応答コードの数。ALBの応答コードは含まれない
- RejectedConnectionCount ロードバランサが最大接続数に達したために拒否された接続の数。ピーキーなアクセスでLBが耐えられないケースはここで落ちると思われる
- パーセンタイルで統計を見るとよいらしい（異常が分離できる？データの分散度合いがわかる）
  - パーセンタイルとは、あるデータ群を最小値から順番に並べていき、ある数値がデータの小さい方から見て何%の一にあるかを示すもの
- TargetResponseTime 平均のレイテンシー

#### SurgeQueueLenght:

> ルーティングを保留中のリクエストの総数。ロードバランサーは、リクエストをルーティングするために正常なインスタンスと接続を確立できない場合、リクエストをキューに入れます。キューの最大サイズは 1,024 です。追加のリクエストは、キューがいっぱいにはると拒否されます

#### SpilloverCount

> []サージキューがいっぱいなため、拒否されたリクエストの総数。

> [HTTP リスナー] ロードバランサーは、HTTP 503 エラーコードを返します。

### アクセスログ
### リクエストのトレース
- X-Amzn-Trace-Idが付与される。ログで確認できる

### CloudTrailのログ


