## DynamoDB
## 概念
- テーブル
- アイテム
- 属性
- プライマリーキー
  - テーブルの追加、更新、削除するときには指定が必須となる属性
  - パーティションキーを指定か、パーティションキーとソートキーを指定できる

  > パーティションキーとソートキーがあるテーブルでは、2 つの項目が同じパーティションキー値を持つこともできます。ただし、それらの 2 つの項目には別のソートキー値が必要です

- セカンダリインデックス
- Global secondary indexとローカルセカンダリインデックスがある

> Global secondary index – テーブルと異なるパーティションキーとソートキーを持つインデックス。
> ローカルセカンダリインデックス – テーブルと同じパーティションキーと、異なるソートキーを持つインデックス。

- DynamoDBストリーム: DynamoDBのイベントをトリガーにlambdaの関数を実行したりできる
  - 例では顧客テーブルを作って、メアドがあるとlamdbaからSESを実行して顧客に連絡するなど

## 読み込み整合性

defaultの結果整合性

> DynamoDB テーブルからの読み込みオペレーションの応答には、最近の書き込みオペレーションの結果が反映されていないことがあります。応答には古いデータが含まれる場合があります。少し時間がたってから読み込みリクエストを繰り返すと、応答で最新のデータが返されます。

強力な整合性のある読み込み

> 強力な整合性のある読み込みをリクエストすると、DynamoDB は成功した以前のすべての書き込みオペレーションからの更新が反映された最新データの応答を返します。強力な整合性のある読み込みは、ネットワークの遅延または停止があった場合には利用できなくなる可能性があります

読み取りオペレーションにConsistentReadパラメータをtrueにすると強い整合性のある読み込みを使用する

## プロビジョニングされたスループット

|                                      | 通常の整合性 | 協力な整合性 |
|--------------------------------------|--------------|--------------|
| 1ユニットあたりの読み込み（最大4KB） | 1秒に2回     | 1秒に1回     |
| 1ユニットあたりの書き込み（最大1KB） | 1秒に1回     | -            |

サイズが最大値を超える場合は追加でキャパシティーユニットを消費する

> アプリケーションの読み込みまたは書き込みリクエストが、テーブルにプロビジョニングされたスループットを超えると、DynamoDB がそれらのリクエストを制限する可能性があります。これが発生すると、リクエストは HTTP 400 コード (Bad Request) と ProvisionedThroughputExceededException で失敗します

### 読み込みキャパシティーユニット

```

a) 1秒あたり読み込みする項目数
b) 項目サイズ
c) 強い整合性のある読み込みが必要化？(必要なら1, そうでないなら2をかける)

a * (b / 4).ceil * ({1,2})

上記から算出する
ex) 80, 3KB, true
pry(main)> 80 * (3.0/4.0).ceil * 1
=> 80

ex) 100, 6KB, true
pry(main)> 100 * (6.0/4).ceil * 1
=> 200
```

Query/Scanオペレーションの場合は計算が変わる

```
ex) 1KBの項目を100個取り出した場合
(100 * 1024 bytes = 100KB) / 4KB = 25 read capacity units
```

### 書き込みキャパシティーユニット

```
a) 1秒あたり書き込みする項目数
b) 項目サイズ

a * (b / 1.0).ceil

ex) 100項目, 512KB
pry> 100 * (0.5 / 1.0).ceil
=> 100
ex) 10項目, 1.5KB
10 * (1.5 / 1.0).ceil
=> 20
```

## パーティションとデータ分散
DynamoDBはデータをパーティションに保存する。

追加のパーティションが割り当てられるタイミングは下記

- テーブルのプロビジョニングされたスループット設定を既存のパーティションがサポートできる以上に増やした
- 既存のパーティションが容量いっぱいになり、より多くのストレージ領域が必要になった

[DynamoDBのパーティション分割問題について｜ハンズラボエンジニアブログ｜ハンズラボ株式会社](https://www.hands-lab.com/tech/entry/1592.html)

## DynamoDBの操作
### 読み込み
- GetItem
- BatchGetItem
- Query 同じパーティションキー値を持つ複数の項目を読み取る。すべての項目の合計サイズを計算して4KBに切り上げる。その数がCU?
- Scan  テーブルのすべての項目を読み込みCUを計算

### 書き込み
- PutItem
- UpdateItem: 更新前後の表示される項目サイズの大きい方でCUを消費
- DeleteItem: 削除。項目のサイズで消費
- BatchWriteItem: 1つ以上のテーブルに最大25個書き込める。計算は各バッチ毎に切り上げた形のものを最終的に足して計算する


## link
- [Amazon DynamoDB の使用開始 \- Amazon DynamoDB](http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/gettingstartedguide/Welcome.html)
- [Amazon DynamoDB とは \- Amazon DynamoDB](http://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/Introduction.html)
